#pragma once

#include <future>
#include <istream>
#include <memory>
#include <string>
#include <type_traits>

#include "synchronization/msg_queue.h"

namespace triad {

namespace synchronization {
template<typename T>
class MsgQueue;
}

class WordInputWorker {
  using WordQueue = synchronization::MsgQueue<std::string>;
  using WordQueuePtr = std::shared_ptr<WordQueue>;
  
  WordQueuePtr word_queue_;
  std::string stop_;
  std::istream& istream_; // to make this class testable

 public:
  WordInputWorker(WordQueuePtr queue, const std::string &stop, std::istream &is)
      : word_queue_(queue), stop_(stop), istream_(is) {}

  // non default constructible                
  WordInputWorker() = delete;
  // non-copyable
  WordInputWorker(const WordInputWorker&) = delete;
  WordInputWorker& operator=(const WordInputWorker&) = delete;
  // non-move-assignable
  WordInputWorker& operator=(WordInputWorker&&) = delete;
  
  // movable (to be possible to move it to std::thread)
  WordInputWorker(WordInputWorker&& rhs) 
      : 
      word_queue_(std::move(rhs.word_queue_)), 
      stop_(std::move(rhs.stop_)), istream_(rhs.istream_) {}
  
  void operator()(std::promise<void>&& prom) {
    CheckValidity(); // will throw if word_queue_ or stop_ are invalid
    
    bool shall_stop = false;

    while (!shall_stop) {
      std::cout << "Enter a text: ";
      std::string line;
      // get line from istream_ 
      // it can be the cin or a file (ifstrem which is used by the unit tests)
      std::getline(istream_, line);

      std::stringstream ss(line);  // split line by " "
      std::string word;

      while (!ss.eof() && !shall_stop) {
        ss >> word; // reading new work
        
        shall_stop = word == stop_; // WARNING! compare it before moving 'word'
        word_queue_->Send(std::move(word));  // thread safe
      }
    }
    
    prom.set_value(); // notify completion of this thread
  }

 private:
  void CheckValidity() const { 
    if (!word_queue_ || stop_.empty()) { // defensive programming
      throw std::runtime_error("Attributes word_queue_ or stop_ are invalid.");
    }
  }
};

}  // namespace triad
